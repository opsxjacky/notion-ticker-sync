# ETF估值指标使用指南

本文档说明如何使用新增的ETF和基金估值指标功能。

## 🎯 新增功能

### 1. PB（市净率）
- **适用资产**：美股、港股、部分ETF
- **数据来源**：yfinance `priceToBook`
- **用途**：衡量股价相对账面价值的水平，适合价值投资参考

### 2. ETF指数PE（追踪指数市盈率）
- **适用资产**：A股ETF（需在映射表中配置）
- **数据来源**：中证指数历史数据
- **用途**：作为ETF估值参考，判断底层指数是否被高估/低估
- **说明**：ETF本身没有PE，使用其追踪指数的PE作为估值参考

### 3. 基金净值增长率
- **适用资产**：场外开放式基金（0开头的6位代码）
- **计算周期**：1个月、3个月、6个月、1年
- **数据来源**：akshare开放式基金历史净值
- **用途**：评估基金的历史业绩表现

---

## 📊 Notion数据库字段配置

要使用这些新功能，需要在Notion数据库中添加以下字段：

### 必需字段（已有）
- `现价` - Number
- `PE` - Number
- `PE百分位` - Number
- `汇率` - Number
- `货币` - Select

### 新增可选字段

#### 1. PB（市净率）
- **字段名**：`PB`
- **类型**：Number
- **格式**：保留2位小数
- **用途**：显示市净率，用于价值投资参考

#### 2. 年化收益
- **字段名**：`年化收益`
- **类型**：Number
- **格式**：百分比或保留2位小数
- **用途**：显示场外基金1年期净值增长率

### 字段添加方法
1. 打开Notion数据库
2. 点击右上角 `+` 添加属性
3. 输入字段名称（如`PB`）
4. 选择类型为 `Number`
5. 保存

**注意**：如果不添加这些字段，代码会跳过更新这些指标，其他功能正常工作。

---

## 🗺️ ETF指数映射表

以下ETF已配置指数映射，可以自动获取指数PE：

### 沪深300系列
- 510300 → 沪深300指数 (000300)
- 159919 → 沪深300指数 (000300)
- 510330 → 沪深300指数 (000300)

### 中证500系列
- 510500 → 中证500指数 (000905)
- 159922 → 中证500指数 (000905)

### 上证50系列
- 510050 → 上证50指数 (000016)
- 510710 → 上证50指数 (000016)

### 科创50系列
- 588000 → 科创50指数 (000688)
- 588080 → 科创50指数 (000688)

### 创业板系列
- 159915 → 创业板指 (399006)
- 159949 → 创业板指 (399006)

### 行业ETF
- 510880 → 中证红利指数 (000922)
- 512000/512880 → 证券公司指数 (399975)
- 512800 → 中证银行指数 (399986)

### 如何添加新的ETF映射

编辑 `main.py` 文件，找到 `ETF_INDEX_MAPPING` 字典，添加新的映射：

```python
ETF_INDEX_MAPPING = {
    # 现有映射...

    # 添加新的映射
    '你的ETF代码': '对应的指数代码',  # 注释：ETF名称
}
```

**指数代码查询**：
- 中证指数：http://www.csindex.com.cn/
- 常见指数代码：
  - 沪深300: 000300
  - 中证500: 000905
  - 上证50: 000016
  - 科创50: 000688
  - 创业板指: 399006

---

## 📈 功能测试结果

### 测试时间
2025-01-02

### 测试结果
✅ **PB市净率**: 成功获取8个美股ETF的PB数据
- SPY: PB = 1.59
- QQQ: PB = 1.72
- VTI: PB = 2.40

✅ **ETF指数PE**: 成功为3个A股ETF获取指数PE
- 510300（沪深300ETF）: PE = 12.48（来自沪深300指数）
- 512800（银行ETF）: PE = 5.48（来自中证银行指数）
- 510500（中证500ETF）: PE = 19.27（来自中证500指数）

✅ **基金净值增长率**: 成功计算2个场外基金的增长率
- 003847: {'1m': -0.17%, '3m': 0.41%, '6m': -0.39%, '1y': 1.18%}
- 003864: {'1m': 0.09%, '3m': 0.67%, '6m': 0.01%, '1y': 1.18%}

---

## ⚠️ 注意事项

### 1. 指数PE数据时效性
中证指数PE数据来自 `stock_zh_index_hist_csindex` API，数据可能不是实时的（测试时数据更新至2024年6月）。这是因为：
- akshare的中证指数接口数据更新延迟
- 作为长期估值参考仍然有价值

**建议**：
- 将指数PE作为相对估值参考，而非绝对值
- 关注PE的历史分位数更有意义
- 可以配合其他估值指标（如PB、股息率）综合判断

### 2. ETF估值的特殊性
- **指数型ETF**：应该看追踪指数的估值
- **行业ETF**：可能包含多只股票，PE是加权平均
- **债券/货币ETF**：没有PE概念，不适用

### 3. 基金净值增长率
- 仅适用于场外开放式基金（代码以0开头）
- 场内ETF无法计算净值增长率（使用市场价格）
- 增长率为简单收益率，未考虑分红再投资

### 4. 数据更新频率
- 指数PE：每次同步时从API获取（可能有延迟）
- PB：每次同步时实时获取
- 基金增长率：每次同步时实时计算

---

## 🚀 使用建议

### 价值投资策略
1. **关注低PB、低PE的资产**：可能被低估
2. **对比历史PE百分位**：判断当前估值水平
3. **行业轮动**：比较不同行业ETF的估值

### 基金筛选策略
1. **长期业绩**：关注1年期增长率
2. **稳定性**：对比不同周期的增长率
3. **风险评估**：增长率波动大说明风险高

### 定投时机
- **PE低+PE百分位低**：适合定投入场
- **PE高+PE百分位高**：考虑减仓或观望
- **基金增长率持续为正**：说明基金管理能力好

---

## 📝 常见问题

### Q1: 为什么我的ETF没有PE数据？
**A**: 需要在 `ETF_INDEX_MAPPING` 中添加该ETF到指数的映射关系。如果ETF是行业主题或特殊策略ETF，可能没有对应的标准指数。

### Q2: PB数据为什么是None？
**A**:
- A股ETF：akshare接口不提供PB数据
- 美股：部分资产yfinance没有PB数据
- 解决方案：手动查询或使用其他数据源

### Q3: 基金增长率计算不准确？
**A**: 基金增长率使用最近N天前的净值计算，可能因为：
- 节假日导致交易日数不精确
- 基金暂停申购赎回期间无净值更新
- 这是近似值，用于趋势参考即可

### Q4: 字段不存在导致更新失败？
**A**: 按照 **Notion数据库字段配置** 部分添加对应字段即可。如果不需要某个指标，可以忽略该错误。

---

## 📞 支持

如有问题或建议，请：
1. 查看代码中的注释和日志输出
2. 检查Notion数据库字段配置
3. 提交Issue到项目仓库

---

**最后更新**: 2025-01-02
